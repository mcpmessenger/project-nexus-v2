## Latest Critical Issues: Deployment Auth Loop & 504 Timeout

### 1. The "Split Brain" Authentication Loop
- **Symptom**: User authenticates successfully with Google, but the chat interface acts as if they are not logged in, asking for auth again immediately.
- **Root Cause Identified**: 
    - **Frontend**: The `rel="noopener noreferrer"` attribute on the auth link was preventing the popup from sending the `session_id` back to the main chat window (`window.opener.postMessage`).
    - **Backend (Local vs Cloud)**: The frontend was connecting to `localhost` in some cases while the backend redirected to `Cloud Run`, causing a mismatch where the session existed on one server but the frontend was checking the other.
- **Fixes Applied**:
    - **Frontend**: Removed `noopener` to allow cross-window communication.
    - **Config**: Forced the frontend (`tools-helper.ts`) to use the **Cloud Run URL** exclusively when in production (`process.env.NODE_ENV === 'production'`), ignoring any `localhost` entries in the database.

### 2. 504 Gateway Timeout on Cloud Run
- **Symptom**: Calls to `#list_calendars` hang for 30-60s then fail with `504 Gateway Timeout` and `Session ID: MISSING`.
- **Root Cause Identified**: 
    - The backend `create_session` logic attempts to write to **Google Cloud Firestore**.
    - On Cloud Run (in the `slashmcp` project), this connection hangs indefinitely, likely due to missing VPC configuration or IAM permissions (`datastore.user` role missing for the service account).
- **Fixes Applied**:
    - **Backend**: Updated `main.py` (`SessionManager`) to respect an `ENABLE_FIRESTORE=false` environment variable.
    - **Deployment**: Redeployed Cloud Run with `ENABLE_FIRESTORE=false` to force **In-Memory Session Storage**. This unblocks the request immediately.

### 3. Persistent Loop (Current Blocker)
- **Status**: Despite the above fixes, the loop persists on the deployed site (`v0-nexus2.vercel.app`).
- **Hypotheses**:
    1. **Third-Party Cookie Blocking**: Browsers (Chrome/Safari) might be blocking the `postMessage` or `localStorage` write if the popup is on a different domain (`accounts.google.com` -> `...run.app`) than the main window (`vercel.app`).
    2. **Supabase Redirects**: The Avatar "Sign In" flow might be redirecting to the wrong URL configuration in Supabase, clearing local storage.
    3. **Session ID Loss**: The `session_id` generated by the backend (In-Memory) is not being successfully captured by the Frontend after the redirect dance.

## Key Configuration (For Debugging)
- **Frontend**: `https://v0-nexus2.vercel.app`
- **Backend (MCP)**: `https://google-workspace-mcp-server-554655392699.us-central1.run.app`
- **Redirect URI**: `.../oauth/callback`
- **Persistence**: **In-Memory** (Firestore Disabled)

## Recommended Next Steps for Support
1. **Verify `window.opener` behavior**: Check if the browser console on the Vercel app shows "Received session ID" or if the message is blocked.
2. **Check Supabase Config**: Ensure `https://v0-nexus2.vercel.app/auth/callback` is in the Supabase Allow List.
3. **Trace Network Headers**: Inspect the `/mcp` request in the Network Tab to see exactly what headers (`X-Session-ID`) are being sent. If it's missing, the frontend logic regarding `localStorage` needs review.
